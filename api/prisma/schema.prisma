generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum Subject {
  ENGLISH
  IT
}

enum QuestionType {
  SC // single choice
  MC // multi choice
  TEXT // short text
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  fullName  String?
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  examsAuthored     Exam[]     @relation("ExamAuthor")
  questionsAuthored Question[] @relation("QuestionAuthor")
  roomsCreated      Room[]     @relation("RoomCreator")
  attempts          Attempt[]
}

model Question {
  id          Int          @id @default(autoincrement())
  subject     Subject
  type        QuestionType
  text        String // nội dung câu hỏi
  explanation String? // giải thích sau khi nộp
  correctText String? // dùng khi type=TEXT (so khớp chính xác/ gần đúng do app xử)
  author      User?        @relation("QuestionAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  authorId    Int?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())

  choices        Choice[] // cho SC/MC
  examLinks      ExamQuestion[]
  attemptAnswers AttemptAnswer[]

  @@index([subject, type])
}

model Choice {
  id                   Int                   @id @default(autoincrement())
  question             Question              @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId           Int
  content              String
  isCorrect            Boolean               @default(false) // dùng cho SC/MC
  order                Int                   @default(0)
  attemptAnswerChoices AttemptAnswerChoice[]

  @@index([questionId])
}

model Exam {
  id          Int      @id @default(autoincrement())
  title       String
  subject     Subject
  description String?
  author      User?    @relation("ExamAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  authorId    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items    ExamQuestion[]
  rooms    Room[]
  attempts Attempt[]

  @@index([subject])
}

model ExamQuestion {
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  examId     Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Restrict)
  questionId Int
  points     Decimal  @default(1.00) @db.Decimal(6, 2)
  order      Int      @default(0)

  @@id([examId, questionId])
  @@index([questionId])
}

model Room {
  id               Int       @id @default(autoincrement())
  exam             Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  examId           Int
  code             String    @unique // dùng làm link: /r/{code}
  openAt           DateTime?
  closeAt          DateTime?
  durationSec      Int? // thời lượng mỗi thí sinh (giống nhau)
  shuffleQuestions Boolean   @default(true)
  shuffleChoices   Boolean   @default(true)
  maxAttempts      Int       @default(1)
  createdBy        User?     @relation("RoomCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdById      Int?
  createdAt        DateTime  @default(now())

  attempts Attempt[]

  @@index([examId])
  @@index([openAt, closeAt])
}

model Attempt {
  id           Int           @id @default(autoincrement())
  room         Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId       Int
  exam         Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  examId       Int
  student      User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId    Int
  status       AttemptStatus @default(IN_PROGRESS)
  startedAt    DateTime      @default(now())
  submittedAt  DateTime?
  score        Decimal?      @db.Decimal(8, 2)
  timeTakenSec Int?

  answers AttemptAnswer[]

  @@unique([roomId, studentId]) // mỗi phòng chỉ được 1 lượt (đổi nếu muốn nhiều lượt)
  @@index([roomId])
  @@index([examId])
  @@index([studentId])
}

model AttemptAnswer {
  id         Int      @id @default(autoincrement())
  attempt    Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  attemptId  Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId Int

  // cho TEXT
  textAnswer String?
  // chấm điểm/đúng-sai (app tính, lưu lại để xem)
  isCorrect  Boolean?
  earned     Decimal? @db.Decimal(6, 2)

  choices AttemptAnswerChoice[] // cho SC/MC

  @@unique([attemptId, questionId])
  @@index([questionId])
}

model AttemptAnswerChoice {
  // mapping các lựa chọn user đã chọn (hỗ trợ MC nhiều lựa chọn)
  attemptAnswer   AttemptAnswer @relation(fields: [attemptAnswerId], references: [id], onDelete: Cascade)
  attemptAnswerId Int
  choice          Choice        @relation(fields: [choiceId], references: [id], onDelete: Cascade)
  choiceId        Int

  @@id([attemptAnswerId, choiceId])
  @@index([choiceId])
}
